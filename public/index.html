<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizador de Terreno Procedural</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }

        h1 {
            text-align: center;
            color: #333;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 5px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: bold;
            margin-bottom: 5px;
        }

        input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #45a049;
        }

        .loading {
            text-align: center;
            margin: 20px 0;
            display: none;
        }

        .error {
            color: #e74c3c;
            padding: 10px;
            background-color: #ffeaea;
            border-radius: 4px;
            margin-top: 10px;
            display: none;
        }

        .terrain-container {
            position: relative;
            overflow: hidden;
            margin-top: 20px;
            border: 1px solid #ddd;
            background-color: #e0e0e0;
        }

        #terrainCanvas {
            display: block;
        }

        .metadata {
            margin-top: 20px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }

        .tile-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 4px;
        }

        .tile-item {
            display: flex;
            align-items: center;
            margin-right: 10px;
        }

        .tile-color {
            width: 20px;
            height: 20px;
            margin-right: 5px;
            border: 1px solid #666;
        }

        .controls-section {
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
        }

        .controls-title {
            font-weight: bold;
            margin-bottom: 10px;
        }

        .camera-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 10px;
        }

        .zoom-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 10px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Visualizador de Terreno Procedural</h1>

        <div class="controls">
            <div class="controls-section">
                <div class="controls-title">Configuración del Mundo</div>
                <div class="control-group">
                    <label for="worldWidth">Ancho del Mundo:</label>
                    <input type="number" id="worldWidth" value="1000" min="100" max="100000">
                </div>
                <div class="control-group">
                    <label for="worldHeight">Alto del Mundo:</label>
                    <input type="number" id="worldHeight" value="1000" min="100" max="100000">
                </div>
                <div class="control-group">
                    <label for="seed">Semilla (opcional):</label>
                    <input type="number" id="seed" placeholder="Aleatorio">
                </div>
            </div>

            <div class="controls-section">
                <div class="controls-title">Configuración de Cámara</div>
                <div class="control-group">
                    <label for="cameraX">Posición X:</label>
                    <input type="number" id="cameraX" value="500" min="0">
                </div>
                <div class="control-group">
                    <label for="cameraY">Posición Y:</label>
                    <input type="number" id="cameraY" value="300" min="0">
                </div>
                <div class="control-group">
                    <label for="cameraWidth">Ancho Visible:</label>
                    <input type="number" id="cameraWidth" value="160" min="10">
                </div>
                <div class="control-group">
                    <label for="cameraHeight">Alto Visible:</label>
                    <input type="number" id="cameraHeight" value="90" min="10">
                </div>
                <div class="control-group">
                    <label for="cameraZoom">Zoom (0.1-10):</label>
                    <input type="number" id="cameraZoom" value="1" min="0.1" max="10" step="0.1">
                </div>
                <div class="control-group">
                    <label for="buffer">Buffer:</label>
                    <input type="number" id="buffer" value="10" min="0" max="100">
                </div>
            </div>

            <div class="controls-section">
                <div class="controls-title">Visualización</div>
                <div class="control-group">
                    <label for="tileSize">Tamaño de Tile (px):</label>
                    <input type="number" id="tileSize" value="8" min="1" max="32">
                </div>
                <div class="control-group">
                    <label for="showGrid">Mostrar Cuadrícula:</label>
                    <input type="checkbox" id="showGrid">
                </div>
            </div>
        </div>

        <div style="text-align: center; margin-bottom: 20px;">
            <button id="generateBtn">Generar Terreno</button>
        </div>

        <div class="loading" id="loadingIndicator">
            Generando terreno...
        </div>

        <div class="error" id="errorMessage"></div>

        <div class="camera-controls">
            <button id="moveUp">↑</button>
            <div>
                <button id="moveLeft">←</button>
                <button id="moveRight">→</button>
            </div>
            <button id="moveDown">↓</button>
        </div>

        <div class="zoom-controls">
            <button id="zoomIn">+</button>
            <button id="zoomOut">-</button>
        </div>

        <div class="terrain-container" id="terrainContainer">
            <canvas id="terrainCanvas"></canvas>
        </div>

        <div class="tile-legend" id="tileLegend">
            <!-- Legend will be populated dynamically -->
        </div>

        <div class="metadata" id="metadata">
            <!-- Metadata will be populated dynamically -->
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Elementos del DOM
            const generateBtn = document.getElementById('generateBtn');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const errorMessage = document.getElementById('errorMessage');
            const terrainCanvas = document.getElementById('terrainCanvas');
            const ctx = terrainCanvas.getContext('2d');
            const metadataDiv = document.getElementById('metadata');
            const tileLegendDiv = document.getElementById('tileLegend');

            // Botones de navegación
            const moveUpBtn = document.getElementById('moveUp');
            const moveDownBtn = document.getElementById('moveDown');
            const moveLeftBtn = document.getElementById('moveLeft');
            const moveRightBtn = document.getElementById('moveRight');
            const zoomInBtn = document.getElementById('zoomIn');
            const zoomOutBtn = document.getElementById('zoomOut');

            // Estado actual del terreno
            let currentTerrain = null;
            let currentTileset = null;
            let currentMetadata = null;

            // Colores para los diferentes tipos de tiles
            const tileColors = {
                'deep_water': '#0000AA',
                'water': '#0066CC',
                'sand': '#FFCC66',
                'grass': '#66CC66',
                'plains': '#AADD88',
                'forest': '#006633',
                'forest_hill': '#004D25',
                'hill': '#996633',
                'mountain': '#666666',
                'snow': '#FFFFFF',
                'desert': '#DDDD77',
                'swamp': '#669966'
            };

            // Inicializar
            setupEventListeners();
            updateCanvasSize();

            // Función para configurar event listeners
            function setupEventListeners() {
                // Evento para generar terreno
                generateBtn.addEventListener('click', generateTerrain);

                // Eventos de navegación de cámara
                moveUpBtn.addEventListener('click', () => moveCamera(0, -20));
                moveDownBtn.addEventListener('click', () => moveCamera(0, 20));
                moveLeftBtn.addEventListener('click', () => moveCamera(-20, 0));
                moveRightBtn.addEventListener('click', () => moveCamera(20, 0));

                // Eventos de zoom
                zoomInBtn.addEventListener('click', () => changeZoom(0.1));
                zoomOutBtn.addEventListener('click', () => changeZoom(-0.1));

                // Actualizar tamaño del canvas cuando cambie el tamaño de tile
                document.getElementById('tileSize').addEventListener('change', updateCanvasSize);

                // Redimensionar canvas al cambiar el tamaño de la ventana
                window.addEventListener('resize', updateCanvasSize);
            }

            // Función para mover la cámara
            function moveCamera(deltaX, deltaY) {
                const cameraXInput = document.getElementById('cameraX');
                const cameraYInput = document.getElementById('cameraY');

                let newX = parseInt(cameraXInput.value) + deltaX;
                let newY = parseInt(cameraYInput.value) + deltaY;

                // Asegurar que la cámara no salga de los límites del mundo
                const worldWidth = parseInt(document.getElementById('worldWidth').value);
                const worldHeight = parseInt(document.getElementById('worldHeight').value);

                newX = Math.max(0, Math.min(newX, worldWidth - 1));
                newY = Math.max(0, Math.min(newY, worldHeight - 1));

                cameraXInput.value = newX;
                cameraYInput.value = newY;

                // Regenerar terreno con la nueva posición
                generateTerrain();
            }

            // Función para cambiar el zoom
            function changeZoom(delta) {
                const zoomInput = document.getElementById('cameraZoom');
                let newZoom = parseFloat(zoomInput.value) + delta;

                // Limitar zoom entre 0.1 y 10
                newZoom = Math.max(0.1, Math.min(newZoom, 10));
                zoomInput.value = newZoom.toFixed(1);

                // Regenerar terreno con el nuevo zoom
                generateTerrain();
            }

            // Función para actualizar el tamaño del canvas
            function updateCanvasSize() {
                const tileSize = parseInt(document.getElementById('tileSize').value);
                const cameraWidth = parseInt(document.getElementById('cameraWidth').value);
                const cameraHeight = parseInt(document.getElementById('cameraHeight').value);
                const buffer = parseInt(document.getElementById('buffer').value);

                // Tamaño del canvas basado en el área visible más buffer
                terrainCanvas.width = (cameraWidth + (buffer * 2)) * tileSize;
                terrainCanvas.height = (cameraHeight + (buffer * 2)) * tileSize;

                // Si ya tenemos terreno, redibujarlo
                if (currentTerrain) {
                    renderTerrain();
                }
            }

            // Función para generar terreno
            function generateTerrain() {
                // Obtener todos los valores del formulario
                const formData = {
                    world_width: parseInt(document.getElementById('worldWidth').value),
                    world_height: parseInt(document.getElementById('worldHeight').value),
                    camera_x: parseInt(document.getElementById('cameraX').value),
                    camera_y: parseInt(document.getElementById('cameraY').value),
                    camera_z: parseFloat(document.getElementById('cameraZoom').value),
                    camera_width: parseInt(document.getElementById('cameraWidth').value),
                    camera_height: parseInt(document.getElementById('cameraHeight').value),
                    buffer: parseInt(document.getElementById('buffer').value)
                };

                // Añadir semilla si está definida
                const seedInput = document.getElementById('seed');
                if (seedInput.value) {
                    formData.seed = parseInt(seedInput.value);
                }

                // Validar datos
                if (formData.camera_x >= formData.world_width ||
                    formData.camera_y >= formData.world_height) {
                    showError("La posición de la cámara está fuera de los límites del mundo");
                    return;
                }

                // Mostrar indicador de carga
                //loadingIndicator.style.display = 'block';
                // TODO - Quitar comentario para mostrar el indicador de carga
                errorMessage.style.display = 'none';

                apiRequest(formData)
                    .then(response => {
                        // Guardar datos
                        currentTerrain = response.terrain;
                        currentTileset = response.tileset;
                        currentMetadata = response.metadata;

                        // Actualizar tamaño del canvas
                        updateCanvasSize();

                        // Renderizar terreno
                        renderTerrain();

                        // Mostrar metadatos
                        metadataDiv.textContent = JSON.stringify(currentMetadata, null, 2);

                        // Generar leyenda
                        generateTileLegend();

                        // Ocultar indicador de carga
                        loadingIndicator.style.display = 'none';
                    })
                    .catch(error => {
                        showError("Error al generar el terreno: " + error.message);
                        loadingIndicator.style.display = 'none';
                    });
            }

            function apiRequest(formData) {
                // a post request to the server
                return fetch('/api/terrain/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Error en la petición al servidor');
                        }
                        return response.json();
                    });
            }

            // Determinar tipo de tile basado en parámetros ambientales
            function determineTileType(elevation, moisture, temperature) {
                // Agua profunda
                if (elevation < 0.2) {
                    return 'deep_water';
                }

                // Agua
                if (elevation < 0.3) {
                    return 'water';
                }

                // Arena/Playa
                if (elevation < 0.35) {
                    return 'sand';
                }

                // Montañas altas
                if (elevation > 0.8) {
                    if (temperature < 0.3) {
                        return 'snow';
                    }
                    return 'mountain';
                }

                // Colinas
                if (elevation > 0.6) {
                    if (moisture > 0.6) {
                        return 'forest_hill';
                    }
                    return 'hill';
                }

                // Terreno normal
                if (moisture > 0.7) {
                    return 'swamp';
                }

                if (moisture > 0.5) {
                    return 'forest';
                }

                if (moisture > 0.3) {
                    return 'grass';
                }

                if (temperature > 0.7) {
                    return 'desert';
                }

                // Terreno por defecto
                return 'plains';
            }

            // Obtener ID del tile basado en su tipo
            function getTileId(type) {
                const tileMap = {
                    'deep_water': 0,
                    'water': 1,
                    'sand': 2,
                    'grass': 3,
                    'plains': 4,
                    'forest': 5,
                    'forest_hill': 6,
                    'hill': 7,
                    'mountain': 8,
                    'snow': 9,
                    'desert': 10,
                    'swamp': 11
                };

                return tileMap[type] || 0;
            }

            // Obtener información del tileset
            function getTileset() {
                return [
                    {
                        'id': 0,
                        'name': 'deep_water',
                        'walkable': false,
                        'image': 'tiles/deep_water.png'
                    },
                    {
                        'id': 1,
                        'name': 'water',
                        'walkable': false,
                        'image': 'tiles/water.png'
                    },
                    {
                        'id': 2,
                        'name': 'sand',
                        'walkable': true,
                        'image': 'tiles/sand.png'
                    },
                    {
                        'id': 3,
                        'name': 'grass',
                        'walkable': true,
                        'image': 'tiles/grass.png'
                    },
                    {
                        'id': 4,
                        'name': 'plains',
                        'walkable': true,
                        'image': 'tiles/plains.png'
                    },
                    {
                        'id': 5,
                        'name': 'forest',
                        'walkable': true,
                        'image': 'tiles/forest.png'
                    },
                    {
                        'id': 6,
                        'name': 'forest_hill',
                        'walkable': true,
                        'image': 'tiles/forest_hill.png'
                    },
                    {
                        'id': 7,
                        'name': 'hill',
                        'walkable': true,
                        'image': 'tiles/hill.png'
                    },
                    {
                        'id': 8,
                        'name': 'mountain',
                        'walkable': false,
                        'image': 'tiles/mountain.png'
                    },
                    {
                        'id': 9,
                        'name': 'snow',
                        'walkable': true,
                        'image': 'tiles/snow.png'
                    },
                    {
                        'id': 10,
                        'name': 'desert',
                        'walkable': true,
                        'image': 'tiles/desert.png'
                    },
                    {
                        'id': 11,
                        'name': 'swamp',
                        'walkable': true,
                        'image': 'tiles/swamp.png'
                    }
                ];
            }

            // Función para renderizar el terreno
            function renderTerrain() {
                if (!currentTerrain) return;

                const tileSize = parseInt(document.getElementById('tileSize').value);
                const showGrid = document.getElementById('showGrid').checked;

                // Limpiar canvas
                ctx.clearRect(0, 0, terrainCanvas.width, terrainCanvas.height);

                // Dibujar cada tile
                for (let y = 0; y < currentTerrain.length; y++) {
                    for (let x = 0; x < currentTerrain[y].length; x++) {
                        const tile = currentTerrain[y][x];
                        const tileType = tile.type;

                        // Dibujar el tile
                        ctx.fillStyle = tileColors[tileType] || '#000000';
                        ctx.fillRect(x * tileSize, y * tileSize, tileSize, tileSize);

                        // Dibujar cuadrícula si está activada
                        if (showGrid) {
                            ctx.strokeStyle = 'rgba(0, 0, 0, 0.2)';
                            ctx.strokeRect(x * tileSize, y * tileSize, tileSize, tileSize);
                        }
                    }
                }

                // Marcar el área visible (sin buffer)
                const buffer = currentMetadata.buffer;
                const visibleStartX = buffer * tileSize;
                const visibleStartY = buffer * tileSize;
                const visibleWidth = currentMetadata.camera.width * tileSize;
                const visibleHeight = currentMetadata.camera.height * tileSize;

                ctx.strokeStyle = 'rgba(255, 0, 0, 0.8)';
                ctx.lineWidth = 2;
                ctx.strokeRect(visibleStartX, visibleStartY, visibleWidth, visibleHeight);
            }

            // Función para generar la leyenda de tiles
            function generateTileLegend() {
                // Limpiar leyenda actual
                tileLegendDiv.innerHTML = '';

                // Crear un elemento para cada tipo de tile
                for (const type in tileColors) {
                    const tileItem = document.createElement('div');
                    tileItem.className = 'tile-item';

                    const tileColor = document.createElement('div');
                    tileColor.className = 'tile-color';
                    tileColor.style.backgroundColor = tileColors[type];

                    const tileName = document.createElement('span');
                    tileName.textContent = type.replace('_', ' ');

                    tileItem.appendChild(tileColor);
                    tileItem.appendChild(tileName);
                    tileLegendDiv.appendChild(tileItem);
                }
            }

            // Función para mostrar mensajes de error
            function showError(message) {
                errorMessage.textContent = message;
                errorMessage.style.display = 'block';
            }

            // Generar un terreno inicial
            generateTerrain();
        });
    </script>
</body>

</html>
